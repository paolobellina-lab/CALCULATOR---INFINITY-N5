<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INFINITY N5 - TACTICAL PC OVERLAY</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050709">

    <style>
        body { 
            background: #050709; 
            color: #fff; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            border: 1px solid #333;
            box-sizing: border-box;
        }
        .column { flex: 1; padding: 20px; border: 1px solid #222; overflow-y: auto; }
        
        #col-nomads { 
            border-right: 2px solid #00ff41; 
            background: linear-gradient(to right, rgba(0,255,65,0.05), transparent); 
        }
        
        #col-pano { 
            border-left: 2px solid #00d2ff; 
            background: linear-gradient(to left, rgba(0,210,255,0.05), transparent); 
        }

        h1 { font-size: 1.2em; text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        
        .card { 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid #333; 
            background: rgba(255,255,255,0.02);
            transition: all 0.3s ease;
        }
        
        .ACTIVE { border-left: 8px solid #00ff41; }
        .UNCONSCIOUS { border-left: 8px solid #ffaa00; background: rgba(255,170,0,0.1); color: #ffaa00; }
        .DEAD { border-left: 8px solid #ff3366; background: rgba(255,51,102,0.1); color: #ff3366; text-decoration: line-through; opacity: 0.5; }
        
        .alias { font-size: 1.4em; font-weight: bold; }
        .details { font-size: 0.8em; color: #aaa; }
        
        #fs-btn {
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(51, 51, 51, 0.8); color: #fff; border: 1px solid #555;
            padding: 10px 20px; cursor: pointer; font-size: 12px; border-radius: 20px;
            text-transform: uppercase; font-weight: bold; z-index: 100;
        }
        #fs-btn:hover { background: #00ff41; color: #000; }
    </style>
</head>
<body>

    <div id="col-nomads" class="column">
        <h1 style="color: #00ff41;">NOMADS SECTOR</h1>
        <div id="units-nomads"></div>
    </div>

    <div id="col-pano" class="column">
        <h1 style="color: #00d2ff;">PANOCEANIA SECTOR</h1>
        <div id="units-pano"></div>
    </div>

    <button id="fs-btn">MODALITÃ€ TATTICA (FULLSCREEN)</button>

    <script type="module">
        // --- REGISTRAZIONE SERVICE WORKER (FONDAMENTALE PER L'INSTALLAZIONE) ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Dashboard SW Registrato!', reg))
                .catch(err => console.log('Errore SW:', err));
        }

        // --- WAKE LOCK (Monitor sempre acceso) ---
        let wakeLock = null;
        const requestWakeLock = async () => {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Monitor PC bloccato: SEMPRE ACCESO');
                }
            } catch (err) { console.log('WakeLock non supportato o negato', err); }
        };

        // --- ATTIVAZIONE AL CLICK SUL PULSANTE ---
        document.getElementById('fs-btn').addEventListener('click', () => {
            requestWakeLock();
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.log(err));
            }
            // Nasconde il pulsante una volta attivato
            document.getElementById('fs-btn').style.display = 'none';
        });

        // Ripristina il Wake Lock se si cambia scheda e si torna indietro
        document.addEventListener('visibilitychange', () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // --- INCOLLA QUI IL TUO CONFIG FIREBASE ---
        const firebaseConfig = { 
            apiKey: "IL_TUO_API_KEY",
            projectId: "IL_TUO_PROGETTO",
            // ... ecc
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ASCOLTO DATABASE IN TEMPO REALE ---
        onSnapshot(collection(db, "sessione_corrente"), (snapshot) => {
            document.getElementById('units-nomads').innerHTML = "";
            document.getElementById('units-pano').innerHTML = "";
            
            snapshot.forEach((doc) => {
                const u = doc.data();
                const card = `
                    <div class="card ${u.state}">
                        <div>
                            <div class="alias">${u.alias}</div>
                            <div class="details">${u.name} | ${u.weapon} | BS ${u.bs}</div>
                        </div>
                        <div style="font-weight:bold; font-size:0.8em; letter-spacing: 1px;">${u.state}</div>
                    </div>
                `;
                const colId = u.player === "G_NOMADS" ? 'units-nomads' : 'units-pano';
                const container = document.getElementById(colId);
                if(container) container.innerHTML += card;
            });
        });
    </script>
</body>
</html>
